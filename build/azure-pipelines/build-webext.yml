resources:
 repositories:
   - repository: BuildTools
     type: git
     name: Framework/BuildTools
     ref: dev

trigger:
  branches:
    include:
      - web-extension

  paths:
    include:
      - src/DevOps

pool:
  vmImage: ubuntu-latest

parameters:
  - name: PublishExtension
    default: false

variables:
- group: Benchmarker

- name: BuildToolsDirectory
  readonly: true
  value: $(Build.SourcesDirectory)/BuildTools/

- name: SourcesDirectory
  readonly: true
  value: $(Build.SourcesDirectory)/Benchmarker/

- name: WebDirectory
  readonly: true
  value: $(SourcesDirectory)/src/DevOps/

- name: ExtensionRootDirectory
  readonly: true
  value: $(WebDirectory)Extension

- name: CorePackageDirectory
  value: $(WebDirectory)Package

- name: BuildToolsPackageDirectory
  readonly: true
  value: $(WebDirectory)Package

- name: TsGenProjects
  value: $(WebDirectory)**/*TsGen.csproj


steps:
- checkout: BuildTools

- checkout: self

- task: DotNetCoreCLI@2
  enabled: false
  displayName: Generate Typings
  inputs:
    command: 'build'
    projects: '$(TsGenProjects)'

- task: PowerShell@2
  displayName: Restore Modules
  inputs:
    targetType: inline
    workingDirectory: $(WebDirectory)
    script: |
      Import-Module $(BuildToolsDirectory)Pipelines/Utils.ps1


      Log-Info "Restoring packages"
      $loc = Get-Location
      foreach($dir in (Get-ChildItem -Directory))
      {
        $pkgJsonPath = Join-Path $dir "package.json"
        if (Test-Path $pkgJsonPath)
        {
          Log-Info "Restoring module ${dir.Name}"
          try
          {
            cd $dir
            npm install
          }
          finally
          {
            Set-Location $loc
          }
        }
      }

- task: PowerShell@2
  displayName: Restore Modules
  inputs:
    targetType: inline
    workingDirectory: $(WebDirectory)
    script: |
      Import-Module $(BuildToolsDirectory)Pipelines/Utils.ps1
      $loc = Get-Location

      Log-Debug "Build Common package"
      Set-Location Common
      npm run build
      if ($LASTEXITCODE -ne 0)
      {
        exit 1
      }

      foreach($dir in (Get-ChildItem -Directory))
      {
        if ($dir.Name -eq 'Common')
        {
          continue;
        }
        $pkgJsonPath = Join-Path $dir "package.json"
        if (Test-Path $pkgJsonPath)
        {
          Log-Info "Restoring module ${dir.Name}"
          try
          {
            cd $dir
            npm run build
          }
          finally
          {
            Set-Location $loc
          }
        }
      }


- task: Bash@3
  displayName: Build Vsix
  inputs:
    targetType: 'inline'
    script: |
      vso='##vso'
      errPrefix="${vso}[task.logissue type=error]"
      pat_file=pat.txt

      set +e -x
      pat=$(Benchmarker.AccessToken)
      [ "${pat}x" == "x" ] && \
        echo "${errPrefix}Build access token missing" && \
        exit 1

      cd $(ExtensionRootDirectory) && \
      echo "$(Benchmarker.AccessToken)" > "$pat_file" && \
      npx webpack build --env vsix-output-dir=$(Build.ArtifactStagingDirectory)
      rc=$?

      extpath=$(find '$(Build.ArtifactStagingDirectory)' -type f -name 'sw-*.vsix' -exec readlink -f '{}' \;)

      nbLines=$(echo $extpath | wc -l)
      [[ $nbLines > 1 ]] && \
      echo -e "##[error]Multiple vsix extension files found:\n$extpath" && \
      exit 1

      [[ $nbLines == 0 ]] && \
      echo -e "##[error]No .vsix files found in directory $(Build.ArtifactStagingDirectory)" && \
      ls '$(Build.ArtifactStagingDirectory)' && \
      exit 1

      echo "##vso[task.setvariable variable=Extension.VsixPath]$extpath"

      rm -f $pat_file
      exit $rc

- ${{ if parameters.PublishExtension }}:
  - task: PowerShell@2
    displayName: Publish Extension
    inputs:
      workingDirectory: $(ExtensionRootDirectory)
      filePath: $(SourcesDirectory)build/scripts/Publish-Extension.ps1
      arguments: -PAT '$(Benchmarker.AccessToken)' "$(Extension.VsixPath)"
