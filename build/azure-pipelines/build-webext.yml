resources:
 repositories:
   - repository: BuildTools
     type: git
     name: Framework/BuildTools
     ref: dev

trigger:
- web-extension

pool:
  vmImage: ubuntu-latest

variables:
- name: SourcesDirectory
  value: Benchmarker/

- name: ExtensionRootDirectory
  value: $(SourcesDirectory)src/DevOps/Extension

- group: Benchmarker

steps:
- checkout: BuildTools

- checkout: self
  
- task: Npm@1
  displayName: Npm install
  inputs:
    command: 'install'
    workingDir: $(ExtensionRootDirectory)

- task: Npm@1
  displayName: Run Tests
  inputs:
    command: 'custom'
    workingDir: $(ExtensionRootDirectory)
    customCommand: 'run test'

    
- task: Bash@3
  displayName: Build Vsix
  inputs:
    targetType: 'inline'
    script: |
      vso='##vso'
      errPrefix="${vso}[task.logissue type=error]"
      pat_file=pat.txt

      set +e -x
      pat=$(Benchmarker.AccessToken)
      if [ "${pat}x" == "x" ]; then
        echo "${errPrefix}Build access token missing"
        exit 1
      fi

      cd $(ExtensionRootDirectory) && \
      echo "$(Benchmarker.AccessToken)" > "$pat_file" && \
      npx webpack build --env vsix-output-dir=$(Build.ArtifactStagingDirectory)
      rc=$?

      extpath=$(find '$(Build.ArtifactStagingDirectory)' -type f -name 'sw-*.vsix' -exec readlink -f '{}' \;)

      nblines=$($extPath | wc -l)
      [[ $nbLines > 1 ]] && \
      echo -e "##[error]Multiple vsix extension files found:\n$extPath" && \
      exit 1

      [[ $nbLines == 0 ]] && \
      echo -e "##[error]No .vsix files found in directory $(Build.ArtifactStagingDirectory)" && \
      ls '$(Build.ArtifactStagingDirectory)' && \
      exit 1

      echo "##vso[task.setvariable variable=Extension.VsixPath]$extPath"

      rm -f $pat_file
      exit $rc

- task: PowerShell@2
  displayName: Publish Extension
  inputs:
    workingDirectory: $(ExtensionRootDirectory)
    filePath: $(SourcesDirectory)build/scripts/Publish-Vsix.ps1
    arguments: -PAT $(Benchmarker.AccessToken) --Vsix "$(Extension.VsixPath)"
