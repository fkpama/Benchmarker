trigger:
- none

pool:
  vmImage: ubuntu-latest

parameters:
    - name: PackageVersion
      type: string
      displayName: Package Version
      default: '*'

variables:
    BuildConfiguration: Debug
    FrameworkProjectPath: src/Core/Framework/Framework.csproj
    TestAdapterProjectPath: src/MsTests/TestAdapter/TestAdapter.csproj
    Build.PackageVersion: ${{ parameters.PackageVersion }}


steps:

- checkout: self
  clean: true
  fetchDepth: 0
  persistCredentials: true

- ${{ if eq(parameters.PackageVersion, '*') }}:
  - task: PowerShell@2
    displayName: Compute Package Version
    inputs:
      targetType: 'inline'
      script: |
        &build/scripts/AutoVer.ps1 -TagPrefix dev/ -VersionVariable 'Build.PackageVersion' -TagVariable 'Build.PackageGitTag'

- task: DotNetCoreCLI@2
  displayName: Restore Projects
  inputs:
    command: 'restore'
    projects: |
      $(FrameworkProjectPath)
      $(TestAdapterProjectPath)
    feedsToUse: 'select'
- task: DotNetCoreCLI@2
  displayName: Build Packages
  inputs:
    command: 'pack'
    packagesToPack: '$(FrameworkProjectPath);$(TestAdapterProjectPath)'
    versioningScheme: 'off'
    buildProperties: 'PackageVersion=$(Build.PackageVersion)'

- task: Bash@3
  displayName: Update tag
  inputs:
    targetType: 'inline'
    script: |
      # Write your commands here
      ls $(Build.ArtifactStagingDirectory)

- task: Bash@3
  condition: and(succeeded(), ne(variables['Build.PackageGitTag'], '*'))
  displayName: Tag Version
  inputs:
    targetType: 'inline'
    script: |
      git tag $(Build.PackageGitTag) & \
      git push origin $(Build.PackageGitTag)

- task: PowerShell@2
  condition: and(succeeded(), ne(variables['Build.PackageGitTag'], '*'))
  inputs:
    targetType: 'inline'
    script: |
      $datePart=Get-Date -Format yyyyMMdd
      
      $buildName="(Build.PackageGitTag)-$(Build.SourceBranchName)-${datePart}.$(Build.BuildId)"
      
      Write-Host "##vso[build.updatebuildnumber]$buildName" 